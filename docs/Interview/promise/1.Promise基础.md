# PromiseåŸºç¡€

> æœ¬èŠ‚è¯¾çš„ä»»åŠ¡ï¼š
>
> 1. ç†è§£Promise A+è§„èŒƒçš„åŸºæœ¬æ¦‚å¿µ
> 2. å­¦ä¼šåˆ›å»ºPromise
> 3. å­¦ä¼šé’ˆå¯¹Promiseè¿›è¡Œåç»­å¤„ç†

## é‚“å“¥çš„çƒ¦æ¼

é‚“å“¥å¿ƒä¸­æœ‰å¾ˆå¤šå¥³ç¥ï¼Œä»–ä»Šå¤©ä¸‹å®šå†³å¿ƒï¼Œè¦å‘è¿™äº›å¥³ç¥è¡¨ç™½ï¼Œä»–è®¤ä¸ºï¼Œåªè¦å¥³ç¥å¤Ÿå¤šï¼Œæ ¹æ®æ¦‚ç‡å­¦åŸç†ï¼Œæ€»æœ‰ä¸€ä¸ªä¼šæ¥æ”¶ä»–

ç¨³å¦¥èµ·è§ï¼Œé‚“å“¥å†³å®šä½¿ç”¨**ä¸²è¡Œ**çš„æ–¹å¼è¿›è¡Œè¡¨ç™½ï¼šå…ˆç»™ç¬¬1ä½å¥³ç¥å‘é€çŸ­ä¿¡ï¼Œç„¶åç­‰å¾…å¥³ç¥çš„å›åº”ï¼Œå¦‚æœæˆåŠŸäº†ï¼Œå°±ç»“æŸï¼Œå¦‚æœå¤±è´¥äº†ï¼Œåˆ™å†ç»™ç¬¬2ä½å¥³ç¥å‘é€çŸ­ä¿¡ï¼Œä¾æ¬¡ç±»æ¨

![](https://october-x-image-host.oss-cn-hangzhou.aliyuncs.com/markdown-imgs20210618150543.png)

é‚“å“¥çš„å¥³ç¥ä¸€å…±æœ‰4ä½ï¼Œåå­—åˆ†åˆ«æ˜¯ï¼šæå»ºå›½ã€ç‹å¯Œè´µã€å‘¨èšè´¢ã€åˆ˜äººå‹‡

å‘çŸ­ä¿¡æ˜¯ä¸€ä¸ªé‡å¤æ€§çš„åŠ³åŠ¨ï¼Œé‚“å“¥æ˜¯ä¸ªç¨‹åºå‘˜ï¼Œå› æ­¤å†³å®šç”¨å‡½æ•°å°è£…è¿™ä¸ªåŠ¨ä½œ

```javascript
// å‘æŸä½å¥³ç”Ÿå‘é€ä¸€åˆ™è¡¨ç™½çŸ­ä¿¡
// name: å¥³ç¥çš„å§“å
// onFulffiled: æˆåŠŸåçš„å›è°ƒ
// onRejected: å¤±è´¥åçš„å›è°ƒ
function sendMessage(name, onFulffiled, onRejected) {
  // æ¨¡æ‹Ÿ å‘é€è¡¨ç™½çŸ­ä¿¡
  console.log(
    `é‚“å“¥ -> ${name}ï¼šæœ€è¿‘æœ‰è°£è¨€è¯´æˆ‘å–œæ¬¢ä½ ï¼Œæˆ‘è¦æ¾„æ¸…ä¸€ä¸‹ï¼Œé‚£ä¸æ˜¯è°£è¨€ğŸ˜˜`
  );
  console.log(`ç­‰å¾…${name}å›å¤......`);
  // æ¨¡æ‹Ÿ å¥³ç¥å›å¤éœ€è¦ä¸€æ®µæ—¶é—´
  setTimeout(() => {
    // æ¨¡æ‹Ÿ æœ‰10%çš„å‡ ç‡æˆåŠŸ
    if (Math.random() <= 0.1) {
      // æˆåŠŸï¼Œè°ƒç”¨ onFuffiledï¼Œå¹¶ä¼ é€’å¥³ç¥çš„å›å¤
      onFulffiled(`${name} -> é‚“å“¥ï¼šæˆ‘æ˜¯ä¹ï¼Œä½ æ˜¯ä¸‰ï¼Œé™¤äº†ä½ è¿˜æ˜¯ä½ ğŸ˜˜`);
    } else {
      // å¤±è´¥ï¼Œè°ƒç”¨ onRejectedï¼Œå¹¶ä¼ é€’å¥³ç¥çš„å›å¤
      onRejected(`${name} -> é‚“å“¥ï¼šä½ æ˜¯ä¸ªå¥½äººğŸ˜œ`);
    }
  }, 1000);
}
```

æœ‰äº†è¿™ä¸ªå‡½æ•°åï¼Œé‚“å“¥äºæ˜¯å¼€å§‹ç¼–å†™ç¨‹åºå‘é€çŸ­ä¿¡äº†

```javascript
// é¦–å…ˆå‘ æå»ºå›½ å‘é€æ¶ˆæ¯
sendMessage(
  'æå»ºå›½',
  (reply) => {
    // å¦‚æœæˆåŠŸäº†ï¼Œè¾“å‡ºå›å¤çš„æ¶ˆæ¯åï¼Œç»“æŸ
    console.log(reply);
  },
  (reply) => {
    // å¦‚æœå¤±è´¥äº†ï¼Œè¾“å‡ºå›å¤çš„æ¶ˆæ¯åï¼Œå‘ ç‹å¯Œè´µ å‘é€æ¶ˆæ¯
    console.log(reply);
    sendMessage(
      'ç‹å¯Œè´µ',
      (reply) => {
        // å¦‚æœæˆåŠŸäº†ï¼Œè¾“å‡ºå›å¤çš„æ¶ˆæ¯åï¼Œç»“æŸ
        console.log(reply);
      },
      (reply) => {
        // å¦‚æœå¤±è´¥äº†ï¼Œè¾“å‡ºå›å¤çš„æ¶ˆæ¯åï¼Œå‘ å‘¨èšè´¢ å‘é€æ¶ˆæ¯
        console.log(reply);
        sendMessage(
          'å‘¨èšè´¢',
          (reply) => {
            // å¦‚æœæˆåŠŸäº†ï¼Œè¾“å‡ºå›å¤çš„æ¶ˆæ¯åï¼Œç»“æŸ
            console.log(reply);
          },
          (reply) => {
            // å¦‚æœå¤±è´¥äº†ï¼Œè¾“å‡ºå›å¤çš„æ¶ˆæ¯åï¼Œå‘ åˆ˜äººå‹‡ å‘é€æ¶ˆæ¯
            console.log(reply);
            sendMessage(
              'åˆ˜äººå‹‡',
              (reply) => {
                // å¦‚æœæˆåŠŸäº†ï¼Œè¾“å‡ºå›å¤çš„æ¶ˆæ¯åï¼Œç»“æŸ
                console.log(reply);
              },
              (reply) => {
                // å¦‚æœå¤±è´¥äº†ï¼Œå°±å½»åº•æ²¡æˆäº†
                console.log(reply);
                console.log('é‚“å“¥å‘½çŠ¯å¤©ç…å­¤æ˜Ÿï¼Œæ³¨å®šå­¤ç‹¬ç»ˆè€ï¼ï¼');
              }
            );
          }
        );
      }
    );
  }
);
```

è¯¥ç¨‹åºå®Œæˆåï¼Œé‚“å“¥å†…å¿ƒæ˜¯å´©æºƒçš„

è¿™ä¸€å±‚ä¸€å±‚çš„å›è°ƒåµŒå¥—ï¼Œå½¢æˆäº†ä¼ è¯´ä¸­çš„ã€Œ**å›è°ƒåœ°ç‹± callback hell**ã€

é‚“å“¥æ˜¯ä¸ªå®Œç¾ä¸»ä¹‰è€…ï¼Œæ€ä¹ˆèƒ½å¿å—è¿™æ ·çš„ä»£ç å‘¢ï¼Ÿ

è¦è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œéœ€è¦Promiseå‡ºé©¬

## Promiseè§„èŒƒ

Promiseæ˜¯ä¸€å¥—ä¸“é—¨å¤„ç†å¼‚æ­¥åœºæ™¯çš„è§„èŒƒï¼Œå®ƒèƒ½æœ‰æ•ˆçš„é¿å…å›è°ƒåœ°ç‹±çš„äº§ç”Ÿï¼Œä½¿å¼‚æ­¥ä»£ç æ›´åŠ æ¸…æ™°ã€ç®€æ´ã€ç»Ÿä¸€

è¿™å¥—è§„èŒƒæœ€æ—©è¯ç”Ÿäºå‰ç«¯ç¤¾åŒºï¼Œè§„èŒƒåç§°ä¸º[Promise A+](https://promisesaplus.com/)

è¯¥è§„èŒƒå‡ºç°åï¼Œç«‹å³å¾—åˆ°äº†å¾ˆå¤šå¼€å‘è€…çš„å“åº”

Promise A+ è§„å®šï¼š

1.  æ‰€æœ‰çš„å¼‚æ­¥åœºæ™¯ï¼Œéƒ½å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œæ¯ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œåœ¨JSä¸­åº”è¯¥è¡¨ç°ä¸ºä¸€ä¸ª**å¯¹è±¡**ï¼Œè¯¥å¯¹è±¡ç§°ä¹‹ä¸º**Promiseå¯¹è±¡**ï¼Œä¹Ÿå«åšä»»åŠ¡å¯¹è±¡ ![](https://october-x-image-host.oss-cn-hangzhou.aliyuncs.com/markdown-imgs20210618154556.png) 
2.  æ¯ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œéƒ½åº”è¯¥æœ‰ä¸¤ä¸ªé˜¶æ®µã€ä¸‰ä¸ªçŠ¶æ€ ![](https://october-x-image-host.oss-cn-hangzhou.aliyuncs.com/markdown-imgs20210618155145.png)
   æ ¹æ®å¸¸ç†ï¼Œå®ƒä»¬ä¹‹é—´å­˜åœ¨ä»¥ä¸‹é€»è¾‘ï¼š 
   - ä»»åŠ¡æ€»æ˜¯ä»æœªå†³é˜¶æ®µå˜åˆ°å·²å†³é˜¶æ®µï¼Œæ— æ³•é€†è¡Œ
   - ä»»åŠ¡æ€»æ˜¯ä»æŒ‚èµ·çŠ¶æ€å˜åˆ°å®Œæˆæˆ–å¤±è´¥çŠ¶æ€ï¼Œæ— æ³•é€†è¡Œ
   - æ—¶é—´ä¸èƒ½å€’æµï¼Œå†å²ä¸å¯æ”¹å†™ï¼Œä»»åŠ¡ä¸€æ—¦å®Œæˆæˆ–å¤±è´¥ï¼ŒçŠ¶æ€å°±å›ºå®šä¸‹æ¥ï¼Œæ°¸è¿œæ— æ³•æ”¹å˜
3.  `æŒ‚èµ·->å®Œæˆ`ï¼Œç§°ä¹‹ä¸º`resolve`ï¼›`æŒ‚èµ·->å¤±è´¥`ç§°ä¹‹ä¸º`reject`ã€‚ä»»åŠ¡å®Œæˆæ—¶ï¼Œå¯èƒ½æœ‰ä¸€ä¸ªç›¸å…³æ•°æ®ï¼›ä»»åŠ¡å¤±è´¥æ—¶ï¼Œå¯èƒ½æœ‰ä¸€ä¸ªå¤±è´¥åŸå› ã€‚
![](https://october-x-image-host.oss-cn-hangzhou.aliyuncs.com/markdown-imgs20210618160538.png) 
4.  å¯ä»¥é’ˆå¯¹ä»»åŠ¡è¿›è¡Œåç»­å¤„ç†ï¼Œé’ˆå¯¹å®ŒæˆçŠ¶æ€çš„åç»­å¤„ç†ç§°ä¹‹ä¸ºonFulfilledï¼Œé’ˆå¯¹å¤±è´¥çš„åç»­å¤„ç†ç§°ä¹‹ä¸ºonRejected
![](https://october-x-image-host.oss-cn-hangzhou.aliyuncs.com/markdown-imgs20210618161125.png) 

## Promise API

ES6æä¾›äº†ä¸€å¥—APIï¼Œå®ç°äº†Promise A+è§„èŒƒ

åŸºæœ¬ä½¿ç”¨å¦‚ä¸‹ï¼š

```javascript
// åˆ›å»ºä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œè¯¥ä»»åŠ¡ç«‹å³è¿›å…¥ pending çŠ¶æ€
const pro = new Promise((resolve, reject) => {
  // ä»»åŠ¡çš„å…·ä½“æ‰§è¡Œæµç¨‹ï¼Œè¯¥å‡½æ•°æ˜¯æè¿°ä»»åŠ¡çš„è¿‡ç¨‹ï¼Œè¯¥å‡½æ•°ä¼šç«‹å³è¢«æ‰§è¡Œ
  // è°ƒç”¨ resolve(data)ï¼Œå¯å°†ä»»åŠ¡å˜ä¸º fulfilled çŠ¶æ€ï¼Œ data ä¸ºéœ€è¦ä¼ é€’çš„ç›¸å…³æ•°æ®
  // è°ƒç”¨ reject(reason)ï¼Œå¯å°†ä»»åŠ¡å˜ä¸º rejected çŠ¶æ€ï¼Œreason ä¸ºéœ€è¦ä¼ é€’çš„å¤±è´¥åŸå› 
});

pro.then(
  (data) => {	
    // onFulfilled å‡½æ•°ï¼Œå½“ä»»åŠ¡å®Œæˆåï¼Œä¼šè‡ªåŠ¨è¿è¡Œè¯¥å‡½æ•°ï¼Œdataä¸ºä»»åŠ¡å®Œæˆçš„ç›¸å…³æ•°æ®
  },
  (reason) => {
    // onRejected å‡½æ•°ï¼Œå½“ä»»åŠ¡å¤±è´¥åï¼Œä¼šè‡ªåŠ¨è¿è¡Œè¯¥å‡½æ•°ï¼Œreasonä¸ºä»»åŠ¡å¤±è´¥çš„ç›¸å…³åŸå› 
  }
);
```
ç¤ºä¾‹ï¼š
```javascript
const pro = new Promise((resolve, reject) => {
  console.log('å¼€å§‹ç™¾ç±³çŸ­è·‘');
  const duration = Math.floor(Math.random() * 5000);

  setTimeout(() => {
    if (Math.random() < 0.5) {
      // æˆåŠŸ
      resolve(duration); // å°†ä»»åŠ¡ä»æŒ‚èµ·->å®Œæˆ
    } else {
      // å¤±è´¥ï¼Œè„šæ‰­ä¼¤äº†
      reject('è„šæ‰­ä¼¤äº†ï¼');
    }
  }, duration);
});
//åç»­å¤„ç†
pro.then(
  (data) => {
    console.log('on yeah! æˆ‘è·‘äº†', data, 'ç§’');
  },
  (reason) => {
    console.log('ä¸å¥½æ„æ€ï¼Œ', reason);
  }
);
```

## é‚“å“¥çš„è§£å†³æ–¹æ¡ˆ

å­¦ä¹ äº†ES6çš„Promiseåï¼Œé‚“å“¥å†³å®šå¯¹`sendMessage`å‡½æ•°è¿›è¡Œæ”¹é€ ï¼Œæ”¹é€ ç»“æœå¦‚ä¸‹ï¼š

```javascript
// å‘æŸä½å¥³ç”Ÿå‘é€ä¸€åˆ™è¡¨ç™½çŸ­ä¿¡
// name: å¥³ç¥çš„å§“å
// è¯¥å‡½æ•°è¿”å›ä¸€ä¸ªä»»åŠ¡å¯¹è±¡
function sendMessage(name) {
  return new Promise((resolve, reject) => {
    // æ¨¡æ‹Ÿ å‘é€è¡¨ç™½çŸ­ä¿¡
    console.log(
      `é‚“å“¥ -> ${name}ï¼šæœ€è¿‘æœ‰è°£è¨€è¯´æˆ‘å–œæ¬¢ä½ ï¼Œæˆ‘è¦æ¾„æ¸…ä¸€ä¸‹ï¼Œé‚£ä¸æ˜¯è°£è¨€ğŸ˜˜`
    );
    console.log(`ç­‰å¾…${name}å›å¤......`);
    // æ¨¡æ‹Ÿ å¥³ç¥å›å¤éœ€è¦ä¸€æ®µæ—¶é—´
    setTimeout(() => {
      // æ¨¡æ‹Ÿ æœ‰10%çš„å‡ ç‡æˆåŠŸ
      if (Math.random() <= 0.1) {
        // æˆåŠŸï¼Œè°ƒç”¨ resolveï¼Œå¹¶ä¼ é€’å¥³ç¥çš„å›å¤
        resolve(`${name} -> é‚“å“¥ï¼šæˆ‘æ˜¯ä¹ï¼Œä½ æ˜¯ä¸‰ï¼Œé™¤äº†ä½ è¿˜æ˜¯ä½ ğŸ˜˜`);
      } else {
        // å¤±è´¥ï¼Œè°ƒç”¨ rejectï¼Œå¹¶ä¼ é€’å¥³ç¥çš„å›å¤
        reject(`${name} -> é‚“å“¥ï¼šä½ æ˜¯ä¸ªå¥½äººğŸ˜œ`);
      }
    }, 1000);
  });
}
```

ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨è¯¥å‡½æ•°æ¥å‘é€æ¶ˆæ¯äº†

```javascript
sendMessage('æå»ºå›½').then(
  (reply) => {
    // å¥³ç¥ç­”åº”äº†ï¼Œè¾“å‡ºå¥³ç¥çš„å›å¤
    console.log(reply);
  },
  (reason) => {
    // å¥³ç¥æ‹’ç»äº†ï¼Œè¾“å‡ºå¥³ç¥çš„å›å¤
    console.log(reason);
  }
);
```

> è‡³æ­¤ï¼Œå›è°ƒåœ°ç‹±çš„é—®é¢˜ä»ç„¶æ²¡èƒ½è§£å†³
>  
> è¦è§£å†³å›è°ƒåœ°ç‹±ï¼Œè¿˜éœ€è¦è¿›ä¸€æ­¥å­¦ä¹ Promiseçš„çŸ¥è¯†

